<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=HandheldFriendly content="True">
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=generator content="Hugo 0.90.1">
<link rel=apple-touch-icon sizes=180x180 href=img/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=img/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=img/favicon-16x16.png>
<link rel=manifest href=img/site.webmanifest>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<title>Go Use Those Traits - The Impatient Software Engineer</title>
<meta name=author content="Prateek">
<meta name=description content="The IO interfaces are one of the best things these languages have">
<meta property="og:title" content="Go Use Those Traits">
<meta name=twitter:title content="Go Use Those Traits">
<meta property="og:type" content="article">
<meta property="og:url" content="https://prateeknischal.github.io/posts/go-use-those-traits/"><meta property="og:description" content="The IO interfaces are one of the best things these languages have">
<meta name=twitter:description content="The IO interfaces are one of the best things these languages have"><meta property="og:image" content="https://prateeknischal.github.io/img/og.png">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://prateeknischal.github.io/img/og.png"><meta property="article:published_time" content="2020-08-30T01:06:21+05:30"><meta property="article:modified_time" content="2020-08-30T01:06:21+05:30">
<link rel=stylesheet href=https://prateeknischal.github.io/assets/css/fuji.min.css>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-W9Z8MHH4V6')</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W9Z8MHH4V6"></script>
</head>
<body data-theme=dark data-theme-auto=false>
<script data-cfasync=false>var fujiThemeData=localStorage.getItem('fuji_data-theme');fujiThemeData?fujiThemeData!=='auto'&&document.body.setAttribute('data-theme',fujiThemeData==='dark'?'dark':'light'):localStorage.setItem('fuji_data-theme','auto')</script>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W9Z8MHH4V6"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-W9Z8MHH4V6',{anonymize_ip:!1})}</script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-W9Z8MHH4V6','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</head>
<main>
<div class="container-lg clearfix">
<div class="col-12 col-md-9 float-left content">
<article>
<h2 class="post-item post-title">
<a href=https://prateeknischal.github.io/posts/go-use-those-traits/>Go Use Those Traits</a>
</h2>
<div class="post-item post-meta">
<span><i class="iconfont icon-today-sharp"></i>&nbsp;2020-08-30</span>
<span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;1854 words</span>
<span><i class="iconfont icon-time-sharp"></i>&nbsp;9 minutes</span>
<span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;No tag</span>
</div>
<div class="post-content markdown-body">
<p><strong>Interfaces</strong> were popularized by Java but originally came from Objective-C
(<a href=https://stackoverflow.com/a/2758619/6266958 target=_blank>source</a>).Until a few days ago I
did not realize how powerful they were. In my opinion, interfaces have been
potrayed in an incomplete manner by all the tutorials. The key idea is correct
but it limits the thinking of what it can be used for.</p>
<p>I am sure everyone who has written some form of object oriented language would
know this example.</p>
<pre><code class=language-java>public interface Animal {
    public String speak();
}

public class Cat implements Animal {
    public String speak() { return &quot;I am a God !&quot;; }
}

public class Dog implements Animal {
    public String speak() { return &quot;Where's my hooman !&quot;; }
}
</code></pre>
<p>And this being used as follows:</p>
<pre><code class=language-java>Animal[] animals = new Animal[2];
animals[0] = new Cat();
animals[1] = new Dog();

for (Animal a : animals) {
    a.speak();
}
</code></pre>
<p>This shows a very generic and boring use of interfaces. Accepting multiple types
to make a function generic or grouping a certain group of objects by an
interface type. You would have seen things like this.</p>
<pre><code class=language-java>public interface Animal {}

public class Cat implements Animal {
    public void walk() { /* Some funny walk */ }
    public void beWeird()  { /* Need I say anything */ }
}

public class Dog implements Animal {
    public void beGoodDoggo() { /* Woof ! */ }
    public void bathe() { throws new RuntimeException(); }
}
</code></pre>
<p>These 2 classes have no common functionality, yet they share an interface. This
is just to mark these classes in a common group, logically. Useful and bit
interesting use too, but we have something better.</p>
<h2 id=how-do-you-test-a-function-that-takes-a-filepath-as-a-parameter>How do you test a function that takes a filepath as a parameter</h2>
<p>I am sure you would have written, at some point of time, a function that takes a
file path as an input and you need to do certain operations on it, maybe read to it, or
write to it and return. Something like this.</p>
<pre><code class=language-java>public int findCharInFile(String path, byte c) {
    /**
    * Open the file by creating a Reader over an input stream and then read
    * operations.
    **/
    return Integer.MAX_VALUE;
}
</code></pre>
<p>How would you write tests for it ? You could do a dummy test file in your
project with the test strings. For a long time I thought that was an ok way.
Recently, I realized, there are better ways to implement it with higher
testability.</p>
<h2 id=whats-problematic-with-that-interface-design>What&rsquo;s problematic with that interface design</h2>
<p>The above API isn&rsquo;t wrong, but it has some problems with it.</p>
<ul>
<li>
<p>Testing becomes a problem, if you have more of those functions, your project
will have a lot of stray files which are filled with different test cases.</p>
</li>
<li>
<p>The function signature doesn&rsquo;t convey it needs a file and not some random
string. Arguably, it would be just made as <code>findCharInFile(File file, byte c)</code>
but it&rsquo;s a generalized perspective with all the languages.</p>
</li>
<li>
<p>You don&rsquo;t know anything about the ownership of the file, what should you do
once you get that File object.</p>
</li>
<li>
<p>And the most fascinating, what do you do when it&rsquo;s not a regular file.</p>
</li>
</ul>
<h2 id=how-to-solve-the-above-problems>How to solve the above problems</h2>
<p>We write a function signature that expresses what is intended only. Every
construct in a language has constraints on it. The less the constraints the more
flexible it becomes. The real intent here is to read some bytes from a stream
and then do some processing over it. Why limit it to a file ?</p>
<p>Enters the abstract class, <a href=https://docs.oracle.com/javase/7/docs/api/java/io/Reader.html target=_blank><code>java.io.Reader</code></a>.
It defines exactly the behaviour we need. An Entity, we don&rsquo;t care what,
with a <code>read</code> function.</p>
<pre><code class=language-java>public int findCharInFile(Reader rd, byte c) throws IOException {
    char buf[] = new char[4096];
    int pos = 0;
    while (rd.read(buf) != -1) {
        /* Find the char by interating the buffer. */
    }

    return pos;
}
</code></pre>
<p>Since, the
<a href=https://docs.oracle.com/javase/7/docs/api/java/io/Reader.html target=_blank><code>java.io.Reader</code></a>
implements <a href=https://docs.oracle.com/javase/7/docs/api/java/io/Closeable.html target=_blank><code>java.io.Closeable</code></a>
iterface as well, it gives an API for the caller to be able to close the stream.
This might give a bit more control by default as there is no way to not allow
the caller to close the stream without wrapping it into another class that
does not expose those APIs.</p>
<p>How do you test it ?</p>
<pre><code class=language-java>public class DummReader implements Reader {
    /* implement all the methods required by the Reader abstract class */
}
</code></pre>
<p>and you can pass this to the function.</p>
<p>Let&rsquo;s look at some newer langauges and in some more detail.</p>
<hr>
<p><a href=https://golang.org target=_blank>golang</a> is the new language for the writing webservers and
things on the internet. I am looking at you, NodeJS.</p>
<p>I feel bringing JS to the backend was a mistake, or atleast not regulating it.
I have an imperative programming background. Also, I have worked a bit on a few NodeJS
projects. For some reason, it didn&rsquo;t seem receptive to me and it had certain
inconsistencies that made it hard for me to write correct code. I know a lot of
the veterans (irrespective of their backgrounds) will disagree with me, but I
didn&rsquo;t feel that with other languages, so, just my opinion, no one needs to
agree to it.</p>
<p>Back to go, it&rsquo;s an incredibly well designed language with constructs that
are simple to use and most importantly, easy to read. It looks minimalist yet has a
loaded standard library.</p>
<p>Go has 2 interfaces that has the power to change the way you write code.
They are:</p>
<ul>
<li><a href=https://golang.org/pkg/io/#Writer target=_blank><code>io.Writer</code></a></li>
<li><a href=https://golang.org/pkg/io/#Reader target=_blank><code>io.Reader</code></a></li>
</ul>
<p>There are other interfaces too that can help you write even cleaner and self
explanatory code, but let&rsquo;s start with this.</p>
<p>Let&rsquo;s see how the same function would look in go, but with these constructs.</p>
<pre><code class=language-go>func findCharInFile(rd io.Reader, c rune) int {
    contents, _ := ioutil.ReadAll(rd)
    return strings.IndexRune(contents, c)
}
</code></pre>
<p>This is piece of code has acheived the following things,</p>
<ul>
<li>
<p>The function signature clarifies exactly what it needs. The <code>io.Reader</code>
interface requires exactly one implementation, that is <code>Read([]byte) (int, error)</code>. This function has no more bussiness than reading the file.</p>
</li>
<li>
<p>This is much more unit-testable. All you need is a construct that implements
the <code>io.Reader</code> interface. You can mock one up and send it to the function
or use one of the builtins.
eg:</p>
<pre><code class=language-go>func TestFindCharInFile(t *testing.T) {
  // Creates a *Reader type object which uses the supplied string as it's
  // backend and is Read only.
  rd := strings.NewReader(&quot;Contents of your test string&quot;)
  if findCharInFile(rd, rune('$')) != -1 {
      t.Fail()
  }
}
</code></pre>
</li>
<li>
<p>This expresses the permissions you have on the stream. The <code>io.Reader</code> only
has a <code>Read([]byte)</code> function, so you can&rsquo;t use it to do anything else
with it unlike when you have the file path and you are responsible for opening
and closing it.</p>
</li>
<li>
<p>It abstracts the underlying provider of the readable stream. It could be a
file on the disk, an in-memory buffer, some key value store, even the network.
It just has to adhere to one property or should have atleast the <code>Read</code> <code>trait</code>, to be
able to Read out bytes to a bytes buffer.</p>
</li>
<li>
<p>It also tells you the ownership of the underlying object. The caller is only
only allowed to read the stream and not do anything else with it, like close
the stream when it thinks it&rsquo;s done. Maybe other&rsquo;s are still reading it, that
would cause a <a href=https://blog.golang.org/defer-panic-and-recover target=_blank>panic</a>,
quite literally.</p>
</li>
</ul>
<p>The same thing goes with <code>io.Writer</code>. It&rsquo;s only allowed to <code>Write([]byte) (int, error)</code> and will not allow the user to close it.</p>
<h3 id=what-if-you-wanted-the-user-to-close-it>What if you wanted the user to close it.</h3>
<p>If you want to hand over or delegate the control of the stream to the caller,
you can use one of the derived interfaces, <a href=https://golang.org/pkg/io/#ReadCloser target=_blank>ReadCloser</a>.</p>
<pre><code class=language-go>type ReadCloser interface {
    Reader
    Closer
}
</code></pre>
<p>You can hand this out and let the caller be able to close the stream. There are
other such interfaces that Go provides by default and you can create your own
too.</p>
<h2 id=can-rust-do-it>Can Rust do it</h2>
<p>We can&rsquo;t not talk about Rust in this case. The title mentions to use the
<a href=https://doc.rust-lang.org/book/ch10-02-traits.html target=_blank><code>trait</code></a>
related.
which is the Rust way of definiting features. Every trait can be seen as an
interface and whosoever implements the trait can be said to have implemented
that interface.</p>
<p>How would the same code (thanks to <a href="https://www.reddit.com/r/rust/comments/ik4ijc/go_use_those_traits_the_impatient_software/g439ua9?utm_source=share&utm_medium=web2x&context=3" target=_blank>vlisivka</a>)
look in Rust.</p>
<pre><code class=language-rust>fn find_char_in_file(rd: &amp;mut dyn Read, c: u8) -&gt; Result&lt;Option&lt;usize&gt;&gt; {
    for idx, b in rd.bytes().enumerate() {
        if b? == c {
            Ok(Some(idx))
        }
    }
    Ok(None)
}
</code></pre>
<p>Notice the definition,</p>
<pre><code class=language-rust>find_char_in_file(rd: &amp;mut dyn Read, c:u8)
</code></pre>
<p>This conveys that the receiver <code>rd</code> must implement the
<a href=https://doc.rust-lang.org/std/io/trait.Read.html target=_blank><code>io::Read</code></a> trait and that&rsquo;s all
is required for this function to work. Similarly it&rsquo;s easy to test too.</p>
<pre><code class=language-rust>#[cfg(test)]
mod tests {
    use super::*;

    #[derive(Default)]
    struct TestReader();

    impl Read for TestReader {
        fn read(&amp;mut self, &amp;mut &amp;[u8]) -&gt; Result&lt;usize&gt; {
            // Ignoring all the implementation details.
            Ok(0)
        }
    }

    #[test]
    fn test_find_char_in_file() {
        let mut rd = TestReader::default();
        let res = find_char_in_file(&amp;mut rd, 'c' as u8).unwrap();
        assert_eq!(res, None);
    }
}
</code></pre>
<h3 id=what-about-buffering-i-dont-want-to-do-that-on-my-own>What about buffering, I don&rsquo;t want to do that on my own.</h3>
<p>The <a href=https://doc.rust-lang.org/std/io/trait.Read.html target=_blank><code>io::Read</code></a> trait takes
care of that. The buffered Reads are auto implemented traits given the <code>read()</code>
implementation. So, all you need is to write a simple <code>read</code> and rust will take
care of providing a more efficient Buffered read.</p>
<p>The same is possible in go, using the <a href=https://golang.org/pkg/bufio target=_blank><code>bufio</code></a>
package. If you want to imply to the caller that you need a more efficient read
implementation in your interface, you can simply replace the <code>io.Reader</code> with
<code>bufio.Reader</code> interface which implements buffering over an <code>io.Reader</code> for you.</p>
<p>So, it would become something like,</p>
<pre><code class=language-go>func findCharInFile(rd bufio.Reader, c rune) int
</code></pre>
<p>Converting a normal unbuffered reader to a buffered one is easy,</p>
<pre><code class=language-go>bufRd := bufio.NewReader(rd)
</code></pre>
<h2 id=what-did-i-learn>What did I learn</h2>
<p>We haven&rsquo;t even talked about doing the same operations with an underlying
network connection and not a file or a device or an in-memory buffer. But it
would work just fine as network connections too are just Read and Write calls.</p>
<p>This helps simplify writing the code. Notice that those functions now no longer
have to deal with opening and closing files, handling errors that are related to
files.</p>
<p>This explicitly conveys what the caller is responsible for and what can he do
with it, given that the API can do just what the interface allows.</p>
<p>Helps a ton with testability of the code, one of the &ldquo;ilities&rdquo; in software
architecture.</p>
<p>Don&rsquo;t get me wrong, It&rsquo;s not that all of it can&rsquo;t be done in Java. Java also
has interfaces around <code>InputStreams</code> and <code>BufferedInputStreams</code>, <code>Readers</code>
and <code>BufferedReaders</code> etc. All of this can be accomplished in a similar
idiomatic and clean way. But&rsquo;s it&rsquo;s too much to write, Java is too verbose ;)</p>
<p>It&rsquo;s just about a more useful outlook to interfaces.</p>
<h2 id=where-did-i-learn-this-from>Where did I learn this from</h2>
<p>Obviously, I didn&rsquo;t come up with all this. I have been working on a go project
and in order to write better and well organized code, I started looking around
for best practices and found some amazing talks about it. I will link them below
if someone wants to take a look (highly recommended).</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=29LLRKIL_TI" target=_blank>7 common mistakes in go and when to avoid them by spf13</a></li>
<li><a href="https://www.youtube.com/watch?v=oL6JBUk6tj0" target=_blank>How Do You Structure Your Go Apps</a></li>
<li><a href="https://www.youtube.com/watch?v=ltqV6pDKZD8" target=_blank>Go anti-patterns</a></li>
</ul>
<hr>
<p>Discussion thread <a href=https://www.reddit.com/r/rust/comments/ik4ijc/go_use_those_traits_the_impatient_software/ target=_blank>here</a></p>
</div>
</article>
<div class="license markdown-body">
<blockquote>
<p>Unless otherwise noted, the content of this site is licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a>.</p>
</blockquote>
</div>
</div>
<aside class="col-12 col-md-3 float-left sidebar">
<div class="sidebar-item sidebar-pages">
<h3>Pages</h3>
<ul>
<li>
<a href=/posts>Home</a>
</li>
<li>
<a href=/about/>About</a>
</li>
<li>
<a href=/index.xml>RSS</a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-links">
<h3>Links</h3>
<ul>
<li>
<a href=https://github.com/prateeknischal target=_blank><span>GitHub</span></a>
</li>
<li>
<a href=https://twitter.com/pikaynu target=_blank><span>Twitter</span></a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-tags">
<h3>Tags</h3>
<div>
</div>
</div>
<div class="sidebar-item sidebar-toc">
<h3>Table of Contents</h3><nav id=TableOfContents>
<ul>
<li><a href=#how-do-you-test-a-function-that-takes-a-filepath-as-a-parameter>How do you test a function that takes a filepath as a parameter</a></li>
<li><a href=#whats-problematic-with-that-interface-design>What&rsquo;s problematic with that interface design</a></li>
<li><a href=#how-to-solve-the-above-problems>How to solve the above problems</a>
<ul>
<li><a href=#what-if-you-wanted-the-user-to-close-it>What if you wanted the user to close it.</a></li>
</ul>
</li>
<li><a href=#can-rust-do-it>Can Rust do it</a>
<ul>
<li><a href=#what-about-buffering-i-dont-want-to-do-that-on-my-own>What about buffering, I don&rsquo;t want to do that on my own.</a></li>
</ul>
</li>
<li><a href=#what-did-i-learn>What did I learn</a></li>
<li><a href=#where-did-i-learn-this-from>Where did I learn this from</a></li>
</ul>
</nav></div>
</aside>
</div>
<div class=btn>
<div class=btn-menu id=btn-menu>
<i class="iconfont icon-grid-sharp"></i>
</div>
<div class=btn-toggle-mode>
<i class="iconfont icon-contrast-sharp"></i>
</div>
<div class=btn-scroll-top>
<i class="iconfont icon-chevron-up-circle-sharp"></i>
</div>
</div>
<aside class=sidebar-mobile style=display:none>
<div class=sidebar-wrapper>
<div class="sidebar-item sidebar-pages">
<h3>Pages</h3>
<ul>
<li>
<a href=/posts>Home</a>
</li>
<li>
<a href=/about/>About</a>
</li>
<li>
<a href=/index.xml>RSS</a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-links">
<h3>Links</h3>
<ul>
<li>
<a href=https://github.com/prateeknischal target=_blank><span>GitHub</span></a>
</li>
<li>
<a href=https://twitter.com/pikaynu target=_blank><span>Twitter</span></a>
</li>
</ul>
</div>
<div class="sidebar-item sidebar-tags">
<h3>Tags</h3>
<div>
</div>
</div>
<div class="sidebar-item sidebar-toc">
<h3>Table of Contents</h3>
<nav id=TableOfContents>
<ul>
<li><a href=#how-do-you-test-a-function-that-takes-a-filepath-as-a-parameter>How do you test a function that takes a filepath as a parameter</a></li>
<li><a href=#whats-problematic-with-that-interface-design>What&rsquo;s problematic with that interface design</a></li>
<li><a href=#how-to-solve-the-above-problems>How to solve the above problems</a>
<ul>
<li><a href=#what-if-you-wanted-the-user-to-close-it>What if you wanted the user to close it.</a></li>
</ul>
</li>
<li><a href=#can-rust-do-it>Can Rust do it</a>
<ul>
<li><a href=#what-about-buffering-i-dont-want-to-do-that-on-my-own>What about buffering, I don&rsquo;t want to do that on my own.</a></li>
</ul>
</li>
<li><a href=#what-did-i-learn>What did I learn</a></li>
<li><a href=#where-did-i-learn-this-from>Where did I learn this from</a></li>
</ul>
</nav>
</div>
</div>
</aside>
</main>
<footer>
<div class="container-lg clearfix">
<div class="col-12 footer">
<span>&copy; 2020-2021
<a href=https://prateeknischal.github.io>Prateek</a>
| <a href=https://github.com/prateeknischal/prateeknischal.github.io>Source code</a>
| Powered by <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a>
</span>
</div>
</div>
</footer>
<script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=/assets/js/fuji.min.js></script>
</body>
</html>